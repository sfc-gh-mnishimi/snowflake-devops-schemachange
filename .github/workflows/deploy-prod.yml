# ============================================================
# PROD Áí∞Â¢É„Å∏„ÅÆ„Éá„Éó„É≠„Ç§
# ============================================================
# „Éà„É™„Ç¨„Éº: main „Éñ„É©„É≥„ÉÅ„Å∏„ÅÆ push
# „ÉÑ„Éº„É´: schemachange (Python)
# ============================================================

name: Deploy to PROD

on:
  push:
    branches:
      - main
    paths:
      - 'migrations/**'
      - '.github/workflows/**'

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment: production  # ÊâøË™ç„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ GitHub „ÅßË®≠ÂÆö

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install schemachange
        run: pip install schemachange

      - name: Create private key file
        env:
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
        run: |
          echo "$SNOWFLAKE_PRIVATE_KEY" > /tmp/rsa_key.p8
          chmod 600 /tmp/rsa_key.p8

      - name: Deploy to PROD with schemachange
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
        run: |
          schemachange deploy \
            -f ./migrations \
            -a $SNOWFLAKE_ACCOUNT \
            -u $SNOWFLAKE_USER \
            -r ACCOUNTADMIN \
            -w COMPUTE_WH \
            -d SCHEMACHANGE_PROD_DB \
            -c SCHEMACHANGE_PROD_DB.SCHEMACHANGE.CHANGE_HISTORY \
            --private-key-path /tmp/rsa_key.p8 \
            --create-change-history-table

      - name: Cleanup
        if: always()
        run: rm -f /tmp/rsa_key.p8

      - name: Deployment Summary
        run: |
          echo "üöÄ Successfully deployed to PROD environment"
          echo "üì¶ Database: SCHEMACHANGE_PROD_DB"
          echo "üîß Tool: schemachange"
          echo "‚ö†Ô∏è  This deployment was executed in production"

