name: Deploy to DEV (schemachange)

on:
  push:
    branches:
      - develop

env:
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
  SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
  SNOWFLAKE_DATABASE: SCHEMACHANGE_ZELDA_DEV

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install schemachange
      
      - name: Setup private key
        run: |
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY }}" | base64 -d > /tmp/snowflake_key.p8
          chmod 600 /tmp/snowflake_key.p8
      
      - name: Deploy with schemachange
        run: |
          schemachange deploy \
            --root-folder migrations \
            --snowflake-account $SNOWFLAKE_ACCOUNT \
            --snowflake-user $SNOWFLAKE_USER \
            --snowflake-role $SNOWFLAKE_ROLE \
            --snowflake-warehouse $SNOWFLAKE_WAREHOUSE \
            --snowflake-database $SNOWFLAKE_DATABASE \
            --snowflake-private-key-path /tmp/snowflake_key.p8 \
            --change-history-table $SNOWFLAKE_DATABASE.SCHEMACHANGE.CHANGE_HISTORY \
            --create-change-history-table
      
      - name: Cleanup
        if: always()
        run: rm -f /tmp/snowflake_key.p8
      
      - name: Deployment Summary
        run: |
          echo "‚úÖ Successfully deployed to SCHEMACHANGE_ZELDA_DEV"
          echo "üì¶ Branch: develop"
          echo "üïê Time: $(date)"
